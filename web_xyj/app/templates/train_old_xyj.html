{% extends "layout.html" %}
{% from 'macros.html' import add_data, error_message, warning_message %}

{% block title %}
    <h1>Train</h1>
{% endblock %}

{% block content %}
    {{ add_data('train', data_upload_warnings, data_upload_errors) }}

    <hr>

    <h3>Train</h3>

    <form id="trainForm" method="POST">
        <h5>Data</h5>
        <select name="dataName" required>
            {% for dataset in datasets %}
                <option value="{{ dataset[0] }}">{{ dataset[1] }}</option>
            {% endfor %}
        </select>
        <br>
        <h5>Dataset type</h5>
        <div class="btn-group" id="datasetTypeSelect" data-toggle="buttons">
          <label class="btn btn-primary active">
            <input type="radio" name="datasetType" id="regression" value="regression" autocomplete="off"> Regression
          </label>
          <label class="btn btn-primary">
            <input type="radio" name="datasetType" id="classification" value="classification" autocomplete="off"> Classification
          </label>
        </div>
        <br>

        <h5>Epochs</h5>
        <input type="number" name="epochs" min="1" step="1" value="30" required>

        <h5>Ensemble Size</h5>
        <select name="ensembleSize" required>
            <option value="1" selected="selected">1</option>
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="10">10</option>
        </select>

        <h5>Checkpoint name</h5>
        <!--TODO: Verify that name isn't already in use-->
        <input type="text" name="checkpointName" placeholder="name" required>

        {% if cuda %}
            <h5>GPU</h5>
            <select name="gpu">
                <option value="None">None</option>
                {% for gpu in gpus %}
                    <option value="{{gpu}}">{{gpu}}</option>
                {% endfor %}
            </select>
            <br>
            <br>
        {% endif %}

        <br>
        <br>

        <button id="train" class="btn btn-primary btn-md">Train</button>
        <button id="training" class="btn btn-default btn-md disabled" disabled="disabled" style="display:none">Training</button>
    </form>


    <br>
    <br>

    <table border="1">
        <thead>
          <tr>
            <th rowspan="2">Model</th>
            <th rowspan="2">Valid (↑)</th>
            <th rowspan="2">Unique@1k (↑)</th>
            <th rowspan="2">Unique@10k (↑)</th>
            <th colspan="2">FCD (↓)</th>
            <th colspan="2">SNN (↑)</th>
            <th colspan="2">Frag (↑)</th>
            <th colspan="2">Scaf (↑)</th>
            <th rowspan="2">IntDiv (↑)</th>
            <th rowspan="2">IntDiv2 (↑)</th>
            <th rowspan="2">Filters (↑)</th>
            <th rowspan="2">Novelty (↑)</th>
          </tr>
          <tr>
            <th>Test</th>
            <th>TestSF</th>
            <th>Test</th>
            <th>TestSF</th>
            <th>Test</th>
            <th>TestSF</th>
            <th>Test</th>
            <th>TestSF</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><i>Train</i></td>
            <td><i>1.0</i></td>
            <td><i>1.0</i></td>
            <td><i>1.0</i></td>
            <td><i>0.008</i></td>
            <td><i>0.476</i></td>
            <td><i>0.642</i></td>
            <td><i>0.586</i></td>
            <td><i>1.0</i></td>
            <td><i>0.999</i></td>
            <td><i>0.991</i></td>
            <td><i>0.0</i></td>
            <td><i>0.857</i></td>
            <td><i>0.851</i></td>
            <td><i>1.0</i></td>
            <td><i>1.0</i></td>
          </tr>
          <tr>
            <td>igm_char_vae-rnn</td>
            <td>0.937±0.034</td>
            <td><b>1.0±0.0</b></td>
            <td>0.997±0.002</td>
            <td>0.556±0.203</td>
            <td>1.057±0.237</td>
            <td>0.608±0.004</td>
            <td>0.568±0.005</td>
            <td>0.991±0.005</td>
            <td>0.99±0.004</td>
            <td>0.902±0.037</td>
            <td>0.079±0.009</td>
            <td><b>0.856±0.003</b></td>
            <td><b>0.85±0.003</b></td>
            <td>0.996±0.001</td>
            <td>0.793±0.028</td>
          </tr>
          <tr>
            <td>igm_char_rnn</td>
            <td>0.975±0.026</td>
            <td><b>1.0±0.0</b></td>
            <td><b>0.999±0.0</b></td>
            <td><b>0.073±0.025</b></td>
            <td><b>0.52±0.038</b></td>
            <td>0.601±0.021</td>
            <td>0.565±0.014</td>
            <td><b>1.0±0.0</b></td>
            <td><b>0.998±0.0</b></td>
            <td>0.924±0.006</td>
            <td><b>0.11±0.008</b></td>
            <td><b>0.856±0.0</b></td>
            <td><b>0.85±0.0</b></td>
            <td>0.994±0.003</td>
            <td>0.842±0.051</td>
          </tr>
          <tr>
            <td>igm_frag_jtnn</td>
            <td><b>1.0</b></td>
            <td><b>1.0</b></td>
            <td><b>0.999</b></td>
            <td>0.422</td>
            <td>0.996</td>
            <td>0.556</td>
            <td>0.527</td>
            <td>0.996</td>
            <td>0.995</td>
            <td>0.892</td>
            <td>0.1</td>
            <td>0.851</td>
            <td>0.845</td>
            <td>0.978</td>
            <td><b>0.915</b></td>
          </tr>
          <tr>
            <td>igm_char_vae</td>
            <td>0.977±0.001</td>
            <td><b>1.0±0.0</b></td>
            <td>0.998±0.001</td>
            <td>0.099±0.013</td>
            <td>0.567±0.034</td>
            <td><b>0.626±0.0</b></td>
            <td><b>0.578±0.001</b></td>
            <td>0.999±0.0</td>
            <td><b>0.998±0.0</b></td>
            <td><b>0.939±0.002</b></td>
            <td>0.059±0.01</td>
            <td><b>0.856±0.0</b></td>
            <td><b>0.85±0.0</b></td>
            <td><b>0.997±0.0</b></td>
            <td>0.695±0.007</td>
          </tr>
          <tr>
            <td>igm_char_laae-rnn</td>
            <td>0.899</td>
            <td><b>1.0</b></td>
            <td>0.998</td>
            <td>0.275</td>
            <td>0.777</td>
            <td>0.54</td>
            <td>0.514</td>
            <td>0.999</td>
            <td>0.997</td>
            <td>0.889</td>
            <td>0.107</td>
            <td><b>0.856</b></td>
            <td><b>0.85</b></td>
            <td>0.969</td>
            <td><b>0.952</b></td>
          </tr>
        </tbody>
      </table>


    <br>

    {% if warnings %}
        {% for warning in warnings %}
            {{ warning_message(warning) }}
        {% endfor %}
    {% endif %}

    {% if errors %}
        {% for error in errors %}
            {{ error_message(error) }}
        {% endfor %}
    {% endif %}

    <script type=text/javascript>
        $("#train").click(function() {
            document.getElementById("train").form.submit();
            document.getElementById("train").disabled = "disabled";
        });

        function refresh() {
            $.post("receiver", function(data){
                if (data.training == 1) {
                    document.getElementById("myProgress").style.display = "";
                    document.getElementById("myBar").style.width = data.progress + "%";
                    document.getElementById("train").style.display = "none";
                    document.getElementById("training").style.display = "";
                    document.getElementById("train").disabled = "disabled";
                }
            });
        }
        setInterval(refresh, 500);
    </script>

    <style>
        #myProgress {
        width: 100%;
        background-color: #ddd;
        }
        
        #myBar {
        width: "{{ progress }} %";
        height: 30px;
        background-color: #4CAF50;
        }
    </style>

    <div id="myProgress" style="display:none">
        <div id="myBar"></div>
    </div>

    {% if trained %}
        <h3>Training complete!</h3>

        <h4>Test performance</h4>

        <p>Overall: {{ mean_score }} {{ metric }}</p>

        <h5>By task</h5>
        {% for i in range(num_tasks) %}
            <p>{{ task_names[i] }}: {{ task_scores[i] }} {{ metric }}</p>
        {% endfor %}

    {% endif %}

{% endblock %}
